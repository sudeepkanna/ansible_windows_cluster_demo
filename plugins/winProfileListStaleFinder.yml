<#
DOCUMENTATION:
---
module: winProfileListStaleFinder
short_description: Detects and removes stale Windows ProfileList registry entries
description:
  - Scans the Windows ProfileList registry hive to detect orphaned user profile
    entries that can cause failures in C(ansible.windows.win_user_profile).
  - A profile entry is considered stale when the C(ProfileImagePath) value is
    missing or empty and the corresponding user account no longer exists.
  - The module applies multiple safety guardrails to avoid touching valid or
    in-use profiles.
  - Designed for environments where provisioning tools (for example,
    Cloudbase-Init) create temporary users that are later deleted, leaving
    broken registry state behind.
  - Can run in audit-only mode or enforcement mode.

options:
  state:
    description:
      - Controls whether the module only reports stale entries or removes them.
    type: str
    choices:
      - report
      - absent
    default: report

  validateSidFormat:
    description:
      - Ensures the registry key name is a valid Windows SID before processing.
    type: bool
    default: true

  requireUserSidPrefix:
    description:
      - Restricts processing to user SIDs that start with C(S-1-5-21-), which
        represent local or domain user accounts.
      - Prevents accidental modification of service, system, or virtual accounts.
    type: bool
    default: true

  skipBakKeys:
    description:
      - Skips ProfileList registry keys ending with C(.bak), which Windows may
        create during profile recovery scenarios.
    type: bool
    default: true

  protectWellKnownSids:
    description:
      - Prevents modification of well-known system SIDs such as LocalSystem,
        LocalService, and NetworkService.
    type: bool
    default: true

  requireUnmappedSid:
    description:
      - Requires that the SID cannot be translated to an NT account, indicating
        that the user has already been deleted.
    type: bool
    default: true

  requireHiveNotLoaded:
    description:
      - Ensures the user registry hive is not currently loaded under
        C(HKEY_USERS\<SID>).
      - Prevents deleting profile metadata for users that are logged on or in use.
    type: bool
    default: true

  requireRefCountZeroIfPresent:
    description:
      - If the C(RefCount) registry value exists, requires it to be C(0) before
        considering the profile stale.
      - Provides an additional safety guard against profiles that may still be
        referenced by the system.
    type: bool
    default: true

author:
  - Your Name (@yourhandle)

notes:
  - This module should be executed before using
    C(ansible.windows.win_user_profile) to remove user profiles.
  - It is safe to run repeatedly and supports check mode.
  - Recommended to run in C(state=report) mode first in large environments.

seealso:
  - module: ansible.windows.win_user_profile
  - module: ansible.windows.win_user

EXAMPLES:
---
- name: Audit stale profile registry entries
  winProfileListStaleFinder:
    state: report

- name: Remove stale profile registry entries safely
  winProfileListStaleFinder:
    state: absent

- name: Explicit guardrail configuration
  winProfileListStaleFinder:
    state: absent
    validateSidFormat: true
    requireUserSidPrefix: true
    skipBakKeys: true
    protectWellKnownSids: true
    requireUnmappedSid: true
    requireHiveNotLoaded: true
    requireRefCountZeroIfPresent: true

RETURN:
---
examinedCount:
  description: Number of ProfileList registry keys examined.
  returned: always
  type: int

candidates:
  description: List of detected stale profile registry entries.
  returned: always
  type: list
  elements: dict
  sample:
    - sid: S-1-5-21-1234567890-123456789-123456789-1001
      regPath: HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList\S-1-5-21-...
      reason: ProfileImagePath missing; user deleted; hive not loaded

removedSids:
  description: List of SIDs that were removed when C(state=absent).
  returned: when state=absent
  type: list
  elements: str
#>
